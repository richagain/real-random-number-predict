{% extends "base.html" %}

{% block title %}History - Singapore TOTO Predictor{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-3xl font-bold text-gray-800">Draw History</h1>

    <!-- Pagination Controls -->
    <div class="flex items-center justify-between bg-white rounded-lg shadow p-4">
        <div class="flex items-center gap-4">
            <label class="text-gray-600">Page Size:</label>
            <select id="page-size" class="px-3 py-1 border rounded">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <button id="prev-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Previous</button>
            <span id="page-info" class="px-4">Page 1</span>
            <button id="next-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Next</button>
        </div>
    </div>

    <!-- Results Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Draw #</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Winning Numbers</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Additional</th>
                </tr>
            </thead>
            <tbody id="draws-table" class="divide-y divide-gray-200">
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="total-info" class="text-center text-gray-600"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let pageSize = 20;
    let totalDraws = 0;

    async function loadDraws() {
        const tableBody = document.getElementById('draws-table');
        tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';

        try {
            const response = await fetch(`/api/draws?page=${currentPage}&page_size=${pageSize}`);
            const data = await response.json();

            totalDraws = data.total;
            const totalPages = Math.ceil(totalDraws / pageSize);

            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('total-info').textContent = `Showing ${data.draws.length} of ${totalDraws} draws`;

            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;

            if (data.draws.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No draws found. Click "Update Data" on the dashboard to scrape data.</td></tr>';
                return;
            }

            tableBody.innerHTML = data.draws.map(draw => {
                const date = new Date(draw.draw_date).toLocaleDateString();
                const numbers = draw.winning_numbers.map(n =>
                    `<span class="ball ball-main" style="width:36px;height:36px;font-size:0.875rem;">${n}</span>`
                ).join('');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">#${draw.draw_number}</td>
                        <td class="px-6 py-4 text-gray-600">${date}</td>
                        <td class="px-6 py-4">${numbers}</td>
                        <td class="px-6 py-4">
                            <span class="ball ball-additional" style="width:36px;height:36px;font-size:0.875rem;">${draw.additional_number}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
        }
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadDraws();
        }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        const totalPages = Math.ceil(totalDraws / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            loadDraws();
        }
    });

    document.getElementById('page-size').addEventListener('change', (e) => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        loadDraws();
    });

    loadDraws();
</script>
{% endblock %}
